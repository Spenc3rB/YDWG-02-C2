<!doctype html><html><head><title>YDWG Wi-Fi Client</title><link rel=stylesheet href="./y.css"><meta name=viewport content="width=device-width, initial-scale=1"><script src="./ui.js"></script><script type="text/javascript">
var currAp = "";
var blockScan = 0;
var onShowWifiInfo = function(data){
  if(data.mode === "Client Mode")
    $("#wifi-warn").setAttribute("hidden", "");
  else
    $("#wifi-warn").removeAttribute("hidden");
};

function createInputForAp(ap) {
  if (ap.essid=="" && ap.rssi==0) return;

  var input = e("input");
  input.type = "radio";
  input.name = "essid";
  input.value=ap.essid;
  input.id   = "opt-" + ap.essid;
  if (currAp == ap.essid) input.checked = "1";

  var bars    = e("div");
  // var rssiVal = -Math.floor(ap.rssi/51)*32;
  var r = -ap.rssi;
  var rssiVal = 160;
  if (r < 90) rssiVal -= 32;
  if (r < 80) rssiVal -= 32;
  if (r < 70) rssiVal -= 32;
  if (r < 67) rssiVal -= 32;

  bars.className = "lock-icon";
  bars.style.backgroundPosition = "0px "+(rssiVal-1)+"px";

  var rssi = e("div");
  rssi.innerHTML = "" + ap.rssi +"dB";

  var encrypt = e("div");
  var encVal  = "-65"; //assume wpa/wpa2
  if (ap.enc == "0") encVal = "0"; //open
  if (ap.enc == "1") encVal = "-33"; //wep
  encrypt.className = "lock-icon";
  encrypt.style.backgroundPosition = "-32px "+encVal+"px";

  var label = e("div");
  label.innerHTML = ap.essid;

  var div = m('<label for=\"opt-' + ap.essid + '"></label>').childNodes[0];
  div.appendChild(input);
  div.appendChild(encrypt);
  div.appendChild(bars);
  div.appendChild(rssi);
  div.appendChild(label);
  return div;
}

function getSelectedEssid() {
  var e = document.forms.wifiform.elements;
  for (var i=0; i<e.length; i++) {
    if (e[i].type == "radio" && e[i].checked) {
      var v = e[i].value;
      if (v == "_hidden_ssid_") v = $("#hidden-ssid").value;
      return v;
    }
  }
  return currAp;
}

var scanTimeout = null;
var scanReqCnt = 0;

function scanResult() {
  if (scanReqCnt > 60) {
    return scanAPs();
  }
  scanReqCnt += 1;
  ajaxJson('GET', "/wifi/scan", function(data) {
      currAp = getSelectedEssid();
      if (data.result.inProgress == "0" && data.result.APs.length > 0) {
        $("#aps").innerHTML = "";
        var n = 0;
        for (var i=0; i<data.result.APs.length; i++) {
          if (data.result.APs[i].essid == "" && data.result.APs[i].rssi == 0) continue;
          $("#aps").appendChild(createInputForAp(data.result.APs[i]));
          n = n+1;
        }
        showNotification("" + n + " networks found");
        var cb = $("#connect-button");
        cb.className = cb.className.replace(" pure-button-disabled", "");
        if (scanTimeout != null) clearTimeout(scanTimeout);
        scanTimeout = window.setTimeout(scanAPs, 20000);
      } else {
        window.setTimeout(scanResult, 1000);
      }
    }, function(s, st) {
      window.setTimeout(scanResult, 5000);
  });
}

function scanAPs() {
//  console.log("scanning now");
  if (blockScan) {
    scanTimeout = window.setTimeout(scanAPs, 1000);
    return;
  }
  scanTimeout = null;
  scanReqCnt = 0;
  ajaxReq('POST', "/wifi/scan", function(data) {
    showNotification("Scanning for Wi-Fi networks...");
    window.setTimeout(scanResult, 1000);
  }, function(s, st) {
    if (s == 400) {
      showWarning("Click the link below to start scanning");
      $("#aps").innerHTML =
        "<a href=\"#\" onclick=\"changeWifiMode(3)\">Click here</a> to scan Wi-Fi networks";
    } else showWarning("Failed to scan: " + st);
    //window.setTimeout(scanResult, 1000);
  });
}

var attempts = 0;

function getStatus() {
  ajaxJsonSpin("GET", "/wifi/connstatus", function(data) {
      if (data.status == "OK" || data.status == "Connecting...") {
        $("#aps").innerHTML = "Connecting...";
        showNotification("Connecting...");
        window.setTimeout(getStatus, 1000);
      } else if (data.status == "Connected") {
        var txt = "Connected! Obtained IP "+data.ip;
        showNotification(txt);
        showWifiInfo(data);
        blockScan = 0;
        if (data.modechange == "yes") {
          var txt2 = "Will switch to Client mode in a few seconds";
          window.setTimeout(function() { showNotification(txt2); }, 4000);
        }
        $("#reconnect").removeAttribute("hidden");
        $("#reconnect").innerHTML =
          "If you are in the same network, go to <a href=\"http://"+data.ip+
          "/\">"+data.ip+"</a>, else connect to network "+data.ssid+" first.";
      } else {
        blockScan = 0;
	if (data.reason == "" || data.reason == "unspecified")
	{
        	showWarning("Connection failed: " + data.status);
	}
	else
	{
		showWarning("Connection failed: " + data.status + ", " + data.reason);
	}
        $("#aps").innerHTML =
          "Check the password and selected network";
      }
    }, function(s, st) {
      //showWarning("Can't get status: " + st);
      attempts = attempts + 1;
      if (attempts < 4) 
      {
	window.setTimeout(getStatus, 2000);
      }
      else
      {
	showNotification("Gateway is connected to another network");
      }
    });
}

function changeWifiMode(m) {
  blockScan = 1;
  hideWarning();
  ajaxSpin("POST", "/wifi/setmode?mode=" + m, function(resp) {
    showNotification("Mode changed");
    window.setTimeout(getWifiInfo, 100);
    blockScan = 0;
    window.setTimeout(scanAPs, 500);
    $("#aps").innerHTML = 'Scanning... <div class="spinner spinner-small"></div>';
  }, function(s, st) {
    showWarning("Error changing mode: " + st);
    window.setTimeout(getWifiInfo, 100);
    blockScan = 0;
  });
}

function changeWifiAp(e) {
  e.preventDefault();
  var passwd = $("#wifi-passwd").value;
  var essid = getSelectedEssid();
  showNotification("Connecting to " + essid);
  var url = "/wifi/connect?essid="+encodeURIComponent(essid)+"&passwd="+encodeURIComponent(passwd);

  hideWarning();
  $("#reconnect").setAttribute("hidden", "");
  $("#wifi-passwd").value = "";
  var cb = $("#connect-button");
  var cn = cb.className;
  cb.className += ' pure-button-disabled';
  blockScan = 1;
  ajaxSpin("POST", url, function(resp) {
      $("#spinner").removeAttribute('hidden'); // hack
      showNotification("Waiting for network change...");
      window.scrollTo(0, 0);
      attempts = 0;	
      window.setTimeout(getStatus, 2000);
    }, function(s, st) {
      showWarning("Error switching network: "+st);
      cb.className = cn;
      window.setTimeout(scanAPs, 1000);
    });
}

function changeSpecial(saveMode) {
  var url = "/wifi/special";
  url += "?dhcp=" + document.querySelector('input[name="dhcp"]:checked').value;
  url += "&staticip=" + encodeURIComponent($("#wifi-staticip").value);
  url += "&staticnetmask=" + encodeURIComponent($("#wifi-staticnetmask").value);
  url += "&staticgateway=" + encodeURIComponent($("#wifi-staticgateway").value);
  url += "&staticdns=" + encodeURIComponent($("#wifi-staticdns").value);
  url += "&savemode=" +  encodeURIComponent(saveMode);

  hideWarning();
  var cb = $("#apply-button");
  var cb1 = $("#save-button");
  addClass(cb, 'pure-button-disabled');
  ajaxSpin("POST", url, function(resp) {
      removeClass(cb, 'pure-button-disabled');
      removeClass(cb1, 'pure-button-disabled');
      //getWifiInfo(); // it takes 1 second for new settings to be applied
    }, function(s, st) {
      showWarning("Error: "+st);
      removeClass(cb, 'pure-button-disabled');
      removeClass(cb1, 'pure-button-disabled');
      getWifiInfo();
    });
}

function doDhcp() {
  $('#dhcp-on').removeAttribute('hidden');
  $('#dhcp-off').setAttribute('hidden', '');
}

function doStatic() {
  $('#dhcp-off').removeAttribute('hidden');
  $('#dhcp-on').setAttribute('hidden', '');
}

</script></head><body><div id=layout><div id=main><div class=header><h1>Wi-Fi Client Configuration</h1></div><div class=content><div class=pure-g><div class="pure-u-1 pure-u-md-1-2"><div class=card><h1>WiFi State</h1><div id=wifi-spinner class="spinner spinner-small"></div><table id=wifi-table class="pure-table pure-table-horizontal" hidden><tbody><tr><td>Wi-Fi Mode:</td><td id=wifi-mode></td></tr><tr><td>WiFi Channel:</td><td id=wifi-chan></td></tr><tr><td>Network SSID:</td><td id=wifi-ssid></td></tr><tr><td>Wi-Fi Status:</td><td id=wifi-status></td></tr><tr><td>Wi-Fi IP Address:</td><td id=wifi-ip></td></tr><tr><td>Wi-Fi RSSI:</td><td id=wifi-rssi></td></tr><tr><td>Connection type:</td><td id=wifi-phy></td></tr><tr><td>MAC Address:</td><td id=wifi-mac></td></tr><tr><td colspan=2 id=wifi-warn></td></tr></tbody></table><p>&nbsp;</p><h1>IP Address Settings</h1><form action="#" id=specform class=pure-form><legend>YDWG should have a static IP address or you will be unable to find it after connecting to the Wi-Fi network.</legend><div class=form-horizontal><label for=dhcp-ron style="margin-right:1em"><input type=radio name=dhcp value=on id=dhcp-ron /> Use DHCP</label><label for=dhcp-roff><input type=radio name=dhcp value=off id=dhcp-roff /> Set Static IP</label></div><div id=dhcp-on class=pure-form-stacked></div><div id=dhcp-off class=pure-form-stacked><label>IP Address</label><input id=wifi-staticip type=text name=staticip /><label>Network Mask</label><input id=wifi-staticnetmask type=text name=netmask /><label>Network Gateway</label><input id=wifi-staticgateway type=text name=gateway /><label>DNS Server</label><input id=wifi-staticdns type=text name=dns /></div><button id=apply-button class="pure-button button-primary" type=button onclick="changeSpecial('apply')">Save &amp; Apply</button> &nbsp; <button id=save-button class="pure-button button-primary" type=button onclick="changeSpecial('save')">Save</button></form></div></div><div class="pure-u-1 pure-u-md-1-2"><div class=card><h1>WiFi Association</h1><p id=reconnect style="color: #600" hidden></p><form action="#" id=wifiform class="pure-form pure-form-stacked"><legend>Be sure that you know the IP address which will be assigned to YDWG after connecting to a new Wi-Fi network.</legend><label>Network SSID</label><div id=aps>Scanning... <div class="spinner spinner-small"></div></div><label for=opt-hiddenssid><input type=radio name=essid value=_hidden_ssid_ id=opt-hiddenssid><input type=text id=hidden-ssid value="" style="width:auto; display:inline-block; margin-left: 0.7em"> Other </label><label>Wi-Fi password, if applicable:</label><input id=wifi-passwd type=password name=passwd placeholder=password><button id=connect-button type=submit class="pure-button button-primary">Connect!</button></form></div></div></div></div></div></div><script type="text/javascript">
onLoad(function() {
  getWifiInfo();
  bnd($("#wifiform"), "submit", changeWifiAp);
  //bnd($("#specform"), "submit", changeSpecial);
  bnd($("#dhcp-ron"), "click", doDhcp);
  bnd($("#dhcp-roff"), "click", doStatic);
  scanTimeout = window.setTimeout(scanAPs, 500);
});
</script></body></html>